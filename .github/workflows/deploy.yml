name: CI/CD for dynamic-pricing-tool-ru

on:
  push:
    branches: [ master ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Deploy over SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -e

            echo "ðŸ‘‰ Go to project"
            cd /home/romab/dynamic-pricing-tool-ru

            echo "ðŸ‘‰ Hard reset repo"
            git fetch origin master
            git reset --hard origin/master
            git clean -fd

            echo "ðŸ‘‰ Init/Update Go modules"
            go mod tidy
            go mod download

            echo "ðŸ‘‰ Build fresh binary"
            CGO_ENABLED=0 GOOS=linux GOARCH=amd64 \
            go build -o app cmd/server/main.go

            echo "ðŸ‘‰ Deploy binary"
            cp app /opt/dynamic-pricing-tool-ru/app
            chmod +x /opt/dynamic-pricing-tool-ru/app

            echo "ðŸ‘‰ Restart service"
            sudo systemctl restart dynamic-pricing-tool-ru

            echo "âœ… Deploy done"
